{% extends "base.html" %}

{% block title %}Admin Dashboard - Colabify{% endblock %}

{% block content %}
<div class="container">
    <h2>Admin Dashboard</h2>
    <p class="text-muted">Overview of platform statistics using database views</p>
    
    <!-- Quick Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>{{ total_users }}</h3>
            <p>Total Users</p>
        </div>
        <div class="stat-card">
            <h3>{{ total_jobs }}</h3>
            <p>Total Jobs</p>
        </div>
        <div class="stat-card">
            <h3>{{ total_applications }}</h3>
            <p>Total Applications</p>
        </div>
        <div class="stat-card">
            <h3>{{ total_messages }}</h3>
            <p>Total Messages</p>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="admin-nav">
        <a href="{{ url_for('main.admin_users') }}" class="btn btn-secondary">Manage Users</a>
        <a href="{{ url_for('main.admin_jobs') }}" class="btn btn-secondary">Manage Jobs</a>
        <a href="{{ url_for('main.admin_applications') }}" class="btn btn-secondary">Manage Applications</a>
        <a href="{{ url_for('main.admin_email_logs') }}" class="btn btn-secondary">Email Validation Logs</a>
    </div>

    <div class="admin-content">
        <!-- User Statistics View -->
        <div class="admin-section">
            <h3>User Statistics (From Database View)</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>User Type</th>
                        <th>Total Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in user_stats %}
                    <tr>
                        <td>{{ stat.user_type.title() }}</td>
                        <td>{{ stat.total_users }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Job Statistics View -->
        <div class="admin-section">
            <h3>Job Statistics (From Database View)</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Total Jobs</th>
                        <th>Average Budget</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in job_stats %}
                    <tr>
                        <td>{{ stat.status.title() }}</td>
                        <td>{{ stat.total_jobs }}</td>
                        <td>${{ "%.2f"|format(stat.avg_budget or 0) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Application Statistics View -->
        <div class="admin-section">
            <h3>Application Statistics (From Database View)</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Total Applications</th>
                        <th>Average Proposed Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in app_stats %}
                    <tr>
                        <td>{{ stat.status.title() }}</td>
                        <td>{{ stat.total_applications }}</td>
                        <td>${{ "%.2f"|format(stat.avg_proposed_rate or 0) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Popular Jobs View -->
        <div class="admin-section">
            <h3>Most Popular Jobs (From Database View)</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Job Title</th>
                        <th>Recruiter</th>
                        <th>Applications</th>
                        <th>Budget</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in popular_jobs %}
                    <tr>
                        <td>{{ job.job_title }}</td>
                        <td>{{ job.recruiter_name }}</td>
                        <td>{{ job.application_count }}</td>
                        <td>${{ "%.2f"|format(job.budget or 0) }}</td>
                        <td><span class="status-badge status-{{ job.status }}">{{ job.status }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Recent Activity View -->
        <div class="admin-section">
            <h3>Recent Platform Activity (From Database View)</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Activity Type</th>
                        <th>Description</th>
                        <th>User</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in recent_activities %}
                    <tr>
                        <td>{{ activity.activity_type.replace('_', ' ').title() }}</td>
                        <td>{{ activity.description }}</td>
                        <td>{{ activity.username }}</td>
                        <td>{{ activity.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Recent Email Validations -->
        <div class="admin-section">
            <h3>Recent Email Validations (Trigger Logs)</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Valid</th>
                        <th>Action</th>
                        <th>Message</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_validations %}
                    <tr class="{% if not log.is_valid %}invalid-email{% endif %}">
                        <td>{{ log.email }}</td>
                        <td>
                            {% if log.is_valid %}
                                <span class="badge-success">✓ Valid</span>
                            {% else %}
                                <span class="badge-danger">✗ Invalid</span>
                            {% endif %}
                        </td>
                        <td>{{ log.action_type.title() }}</td>
                        <td>{{ log.validation_message }}</td>
                        <td>{{ log.attempted_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <a href="{{ url_for('main.admin_email_logs') }}" class="btn btn-primary">View All Email Logs</a>
        </div>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stat-card h3 {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.stat-card p {
    font-size: 1rem;
    opacity: 0.9;
}

.admin-nav {
    display: flex;
    gap: 15px;
    margin: 30px 0;
    flex-wrap: wrap;
}

.admin-content {
    margin-top: 30px;
}

.admin-section {
    background-color: white;
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.admin-section h3 {
    color: var(--primary-color);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--light-bg);
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table thead {
    background-color: var(--light-bg);
}

.admin-table th,
.admin-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.admin-table th {
    font-weight: 600;
    color: var(--text-dark);
}

.admin-table tbody tr:hover {
    background-color: #f8f9fa;
}

.badge-success {
    background-color: var(--success-color);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
}

.badge-danger {
    background-color: var(--danger-color);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
}

.invalid-email {
    background-color: #fff5f5 !important;
}

.text-muted {
    color: var(--text-light);
    margin-bottom: 20px;
}
</style>
{% endblock %}